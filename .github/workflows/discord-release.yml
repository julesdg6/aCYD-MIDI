name: Notify Discord on Release

on:
  workflow_dispatch:
  release:
    types: [published]
    
jobs:
  discordNotification:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_URL: ${{ github.event.release.html_url }}
          RELEASE_BODY: ${{ github.event.release.body }}
          RELEASE_PUBLISHED_AT: ${{ github.event.release.published_at }}
        run: |
          # Discord embed description limit is 2000 characters
          # We use 1900 as a safe buffer to account for formatting
          # Truncate to 1897 to leave room for the 3-char "..." suffix
          MAX_DESCRIPTION_LENGTH=1900
          ELLIPSIS_LENGTH=3
          
          if [ ${#RELEASE_BODY} -gt $MAX_DESCRIPTION_LENGTH ]; then
            TRUNCATE_AT=$((MAX_DESCRIPTION_LENGTH - ELLIPSIS_LENGTH))
            TRUNCATED_BODY="${RELEASE_BODY:0:$TRUNCATE_AT}..."
          else
            TRUNCATED_BODY="$RELEASE_BODY"
          fi
          
          # Create Discord embed payload using jq to properly escape all JSON
          jq -n \
            --arg username "ReleaseBot" \
            --arg avatar "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" \
            --arg title "ðŸš€ New Release: ${RELEASE_NAME:-$RELEASE_TAG}" \
            --arg description "$TRUNCATED_BODY" \
            --arg url "$RELEASE_URL" \
            --arg footer "Published by CI" \
            --arg timestamp "$RELEASE_PUBLISHED_AT" \
            '{
              username: $username,
              avatar_url: $avatar,
              embeds: [{
                title: $title,
                description: $description,
                url: $url,
                color: 5814783,
                footer: {
                  text: $footer
                },
                timestamp: $timestamp
              }]
            }' > payload.json
          
          # Send to Discord
          curl -H "Content-Type: application/json" \
               -d @payload.json \
               "$DISCORD_WEBHOOK"
