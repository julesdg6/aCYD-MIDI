var G=Object.defineProperty;var q=(s,e,t)=>e in s?G(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var r=(s,e,t)=>q(s,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();class J{constructor(){r(this,"listeners",[]);r(this,"t0");this.t0=performance.now()}subscribe(e){return this.listeners.push(e),()=>{const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}}emit(e){const t={id:this.generateId(),tAbsMs:Date.now(),tRelMs:performance.now()-this.t0,...e};this.listeners.forEach(n=>n(t))}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}reset(){this.t0=performance.now()}}const X={midiChannel:1,ccMapping:{cutoff:74,resonance:71,envMod:75,decay:76,accent:77,volume:7},accentMode:"velocity",accentVelocity:120,accentCC:77,accentValue:127,slideMode:"legato",slideCC:65,serialBaudRate:115200,logMaxEntries:1e4,showRawBytes:!1,showDeltaTimes:!0};function M(s){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],t=Math.floor(s/12)-1;return`${e[s%12]}${t}`}function I(s){if(s.length===0)return{kind:"OTHER",data:s};const e=s[0],t=e&240,n=(e&15)+1;switch(t){case 144:return{kind:s[2]>0?"NOTE_ON":"NOTE_OFF",channel:n,data:s,note:s[1],vel:s[2]};case 128:return{kind:"NOTE_OFF",channel:n,data:s,note:s[1],vel:s[2]};case 176:return{kind:"CC",channel:n,data:s,cc:s[1],value:s[2]};case 192:return{kind:"PC",channel:n,data:s,program:s[1]};case 224:const i=s[1]|s[2]<<7;return{kind:"PB",channel:n,data:s,pitchBend:i-8192};default:return e===248?{kind:"CLOCK",data:s}:e===250?{kind:"START",data:s}:e===252?{kind:"STOP",data:s}:e===251?{kind:"CONTINUE",data:s}:e===240?{kind:"SYSEX",data:s}:{kind:"OTHER",data:s}}}function O(s){switch(s.kind){case"NOTE_ON":return`NOTE_ON  ch${s.channel} note=${s.note} (${M(s.note)}) vel=${s.vel}`;case"NOTE_OFF":return`NOTE_OFF ch${s.channel} note=${s.note} (${M(s.note)}) vel=${s.vel}`;case"CC":return`CC       ch${s.channel} cc=${s.cc} val=${s.value}`;case"PC":return`PC       ch${s.channel} program=${s.program}`;case"PB":return`PB       ch${s.channel} value=${s.pitchBend}`;case"CLOCK":return"CLOCK";case"START":return"START";case"STOP":return"STOP";case"CONTINUE":return"CONTINUE";case"SYSEX":return`SYSEX    len=${s.data.length}`;default:return`OTHER    ${s.data.map(e=>e.toString(16).padStart(2,"0")).join(" ")}`}}function B(s){const e=new Date(s),t=e.getHours().toString().padStart(2,"0"),n=e.getMinutes().toString().padStart(2,"0"),i=e.getSeconds().toString().padStart(2,"0"),a=e.getMilliseconds().toString().padStart(3,"0");return`${t}:${n}:${i}.${a}`}function W(s){return s<1e3?`+${s.toFixed(0)}ms`:`+${(s/1e3).toFixed(2)}s`}const T="03b80e5a-ede8-4b33-a751-6ce34ec4c700",z="7772e5db-3868-4112-a1a9-f2669d106bf3";class Q{constructor(e){r(this,"device",null);r(this,"characteristic",null);r(this,"eventBus");r(this,"connected",!1);this.eventBus=e}async connect(){try{if(this.device=await navigator.bluetooth.requestDevice({filters:[{services:[T]}]}),!this.device.gatt)throw new Error("GATT not available");const t=await(await this.device.gatt.connect()).getPrimaryService(T);this.characteristic=await t.getCharacteristic(z),await this.characteristic.startNotifications(),this.characteristic.addEventListener("characteristicvaluechanged",this.handleNotification.bind(this)),this.device.addEventListener("gattserverdisconnected",this.handleDisconnect.bind(this)),this.connected=!0,console.log("BLE MIDI connected")}catch(e){throw console.error("BLE MIDI connection failed:",e),e}}async disconnect(){var e,t;(t=(e=this.device)==null?void 0:e.gatt)!=null&&t.connected&&this.device.gatt.disconnect(),this.connected=!1}handleNotification(e){const n=e.target.value;if(!n)return;const i=new Uint8Array(n.buffer),a=[];for(let o=2;o<i.length;o++)(!(i[o]&128)||o===2)&&a.push(i[o]);if(a.length>0){const o=I(a);this.eventBus.emit({source:"BLE_IN",text:`BLE←MIDI ${this.formatMidiBytes(a)}`,tDeltaMs:0,midi:o})}}handleDisconnect(){this.connected=!1,this.characteristic=null,console.log("BLE MIDI disconnected")}async sendMidi(e,t,n){if(!this.characteristic||!this.connected)throw new Error("BLE MIDI not connected");const i=128,a=128,o=n!==void 0?[i,a,e,t,n]:[i,a,e,t];await this.characteristic.writeValue(new Uint8Array(o));const u=n!==void 0?[e,t,n]:[e,t],h=I(u);this.eventBus.emit({source:"BLE_OUT",text:`BLE→MIDI ${this.formatMidiBytes(u)}`,tDeltaMs:0,midi:h})}formatMidiBytes(e){return e.map(t=>t.toString(16).padStart(2,"0")).join(" ")}isSupported(){return"bluetooth"in navigator}}class Z{constructor(e,t=115200){r(this,"port",null);r(this,"reader",null);r(this,"eventBus");r(this,"baudRate");r(this,"connected",!1);this.eventBus=e,this.baudRate=t}async connect(){try{this.port=await navigator.serial.requestPort(),await this.port.open({baudRate:this.baudRate}),this.connected=!0,this.startReading(),console.log("Serial connected")}catch(e){throw console.error("Serial connection failed:",e),e}}async disconnect(){this.reader&&(await this.reader.cancel(),this.reader=null),this.port&&(await this.port.close(),this.port=null),this.connected=!1}async startReading(){if(!this.port||!this.port.readable)return;const e=new TextDecoderStream,t=this.port.readable.pipeTo(e.writable);this.reader=e.readable.getReader();let n="";try{for(;;){const{value:i,done:a}=await this.reader.read();if(a)break;n+=i;const o=n.split(`
`);n=o.pop()||"";for(const u of o){const h=u.trim();h&&this.eventBus.emit({source:"SERIAL_IN",text:`SERIAL  ${h}`,tDeltaMs:0,serial:{line:h}})}}}catch(i){console.error("Serial read error:",i)}finally{this.reader.releaseLock(),await t.catch(()=>{})}}async sendCommand(e){if(!this.port||!this.port.writable)throw new Error("Serial not connected");const t=this.port.writable.getWriter(),n=new TextEncoder;await t.write(n.encode(e+`
`)),t.releaseLock(),this.eventBus.emit({source:"SERIAL_OUT",text:`SERIAL→ ${e}`,tDeltaMs:0,serial:{line:e}})}isSupported(){return"serial"in navigator}setBaudRate(e){this.baudRate=e}}class ee{constructor(e,t={}){r(this,"entries",[]);r(this,"config");r(this,"paused",!1);r(this,"lastEntryTime",0);r(this,"eventBus");this.eventBus=e,this.config={maxEntries:t.maxEntries||1e4,autoScroll:t.autoScroll!==!1,showDelta:t.showDelta!==!1,filters:t.filters||new Set(["BLE_IN","BLE_OUT","SERIAL_IN","UI_TO_MIDI"]),searchTerm:t.searchTerm||""},this.eventBus.subscribe(n=>{this.paused||this.addEntry(n)})}addEntry(e){this.lastEntryTime>0?e.tDeltaMs=e.tRelMs-this.lastEntryTime:e.tDeltaMs=0,this.lastEntryTime=e.tRelMs,this.entries.push(e),this.entries.length>this.config.maxEntries&&this.entries.shift()}getEntries(){let e=this.entries;if(e=e.filter(t=>this.config.filters.has(t.source)),this.config.searchTerm){const t=this.config.searchTerm.toLowerCase();e=e.filter(n=>n.text.toLowerCase().includes(t))}return e}clear(){this.entries=[],this.lastEntryTime=0,this.eventBus.reset()}pause(){this.paused=!0}resume(){this.paused=!1}isPaused(){return this.paused}updateConfig(e){this.config={...this.config,...e}}exportJson(){return JSON.stringify(this.entries,null,2)}exportCsv(){const e=["Timestamp","Relative (ms)","Delta (ms)","Source","Type","Details"],t=this.entries.map(i=>{var o,u;const a=i.midi?O(i.midi):((o=i.serial)==null?void 0:o.line)||"";return[B(i.tAbsMs),i.tRelMs.toFixed(3),i.tDeltaMs.toFixed(3),i.source,((u=i.midi)==null?void 0:u.kind)||"SERIAL",a]});return[e,...t].map(i=>i.map(a=>`"${a}"`).join(",")).join(`
`)}formatEntry(e){let t="";t+=`<span class="timestamp">${B(e.tAbsMs)}</span>`,this.config.showDelta&&e.tDeltaMs>0&&(t+=`<span class="timestamp"> ${W(e.tDeltaMs)}</span>`);const n=this.formatSource(e.source);return t+=`<span class="source">${n}</span>`,e.midi?t+=O(e.midi):e.serial?t+=e.serial.line:t+=e.text,t}formatSource(e){switch(e){case"UI_TO_MIDI":return"UI→MIDI";case"BLE_IN":return"CYD←BLE";case"BLE_OUT":return"CYD→BLE";case"SERIAL_IN":return"CYD→SER";case"SERIAL_OUT":return"SER→CYD"}}getSourceClass(e){switch(e){case"UI_TO_MIDI":case"BLE_OUT":return"midi-out";case"BLE_IN":return"midi-in";case"SERIAL_IN":case"SERIAL_OUT":return"serial-in"}}}class te{constructor(e){r(this,"bleMidi");r(this,"serial");r(this,"logger");r(this,"eventBus");r(this,"settings");r(this,"currentOctave",3);r(this,"gateEnabled",!1);r(this,"accentEnabled",!1);r(this,"slideEnabled",!1);r(this,"activeNotes",new Set);r(this,"knobValues",new Map);this.eventBus=e,this.settings={...X},this.bleMidi=new Q(e),this.serial=new Z(e,this.settings.serialBaudRate),this.logger=new ee(e,{maxEntries:this.settings.logMaxEntries,showDelta:this.settings.showDeltaTimes}),Object.entries(this.settings.ccMapping).forEach(([t,n])=>{this.knobValues.set(t,64)})}async connectBle(){await this.bleMidi.connect()}async disconnectBle(){await this.bleMidi.disconnect()}async connectSerial(){await this.serial.connect()}async disconnectSerial(){await this.serial.disconnect()}isBleConnected(){return this.bleMidi.connected}isSerialConnected(){return this.serial.connected}async sendNoteOn(e,t){const n=t??(this.accentEnabled&&this.settings.accentMode==="velocity"?this.settings.accentVelocity:100),i=144|this.settings.midiChannel-1;await this.bleMidi.sendMidi(i,e,n),this.activeNotes.add(e),this.eventBus.emit({source:"UI_TO_MIDI",text:`UI→MIDI NOTE_ON note=${e} vel=${n}`,tDeltaMs:0,midi:{kind:"NOTE_ON",channel:this.settings.midiChannel,data:[i,e,n],note:e,vel:n}})}async sendNoteOff(e){const t=128|this.settings.midiChannel-1;await this.bleMidi.sendMidi(t,e,0),this.activeNotes.delete(e),this.eventBus.emit({source:"UI_TO_MIDI",text:`UI→MIDI NOTE_OFF note=${e}`,tDeltaMs:0,midi:{kind:"NOTE_OFF",channel:this.settings.midiChannel,data:[t,e,0],note:e,vel:0}})}async sendCC(e,t){const n=176|this.settings.midiChannel-1;await this.bleMidi.sendMidi(n,e,t),this.eventBus.emit({source:"UI_TO_MIDI",text:`UI→MIDI CC cc=${e} val=${t}`,tDeltaMs:0,midi:{kind:"CC",channel:this.settings.midiChannel,data:[n,e,t],cc:e,value:t}})}async allNotesOff(){const e=176|this.settings.midiChannel-1;await this.bleMidi.sendMidi(e,123,0),await this.bleMidi.sendMidi(e,120,0);for(const t of this.activeNotes)await this.sendNoteOff(t);this.activeNotes.clear()}async sendTestBurst(){const e=[{type:"note",note:60,vel:100},{type:"delay",ms:100},{type:"note",note:64,vel:100},{type:"delay",ms:100},{type:"note",note:67,vel:100},{type:"delay",ms:100},{type:"cc",cc:74,value:0},{type:"delay",ms:50},{type:"cc",cc:74,value:64},{type:"delay",ms:50},{type:"cc",cc:74,value:127},{type:"delay",ms:100},{type:"noteOff",note:60},{type:"noteOff",note:64},{type:"noteOff",note:67}];for(const t of e)t.type==="note"?await this.sendNoteOn(t.note,t.vel):t.type==="noteOff"?await this.sendNoteOff(t.note):t.type==="cc"?await this.sendCC(t.cc,t.value):t.type==="delay"&&await new Promise(n=>setTimeout(n,t.ms))}setOctave(e){this.currentOctave=Math.max(0,Math.min(8,e))}getOctave(){return this.currentOctave}toggleGate(){this.gateEnabled=!this.gateEnabled}isGateEnabled(){return this.gateEnabled}toggleAccent(){this.accentEnabled=!this.accentEnabled}isAccentEnabled(){return this.accentEnabled}toggleSlide(){this.slideEnabled=!this.slideEnabled}isSlideEnabled(){return this.slideEnabled}setKnobValue(e,t){this.knobValues.set(e,t)}getKnobValue(e){return this.knobValues.get(e)||64}getLogger(){return this.logger}getSettings(){return{...this.settings}}updateSettings(e){this.settings={...this.settings,...e},e.serialBaudRate!==void 0&&this.serial.setBaudRate(e.serialBaudRate),(e.logMaxEntries!==void 0||e.showDeltaTimes!==void 0)&&this.logger.updateConfig({maxEntries:this.settings.logMaxEntries,showDelta:this.settings.showDeltaTimes})}}const k=new J,l=new te(k),d=l.getLogger(),c=s=>document.getElementById(s),R=c("connect-ble"),_=c("connect-serial"),se=c("ble-status"),ne=c("serial-status"),ie=c("ble-label"),ae=c("serial-label"),L=c("keyboard"),$=c("octave-display"),ce=c("oct-down"),oe=c("oct-up"),y=c("gate-toggle"),D=c("accent-toggle"),N=c("slide-toggle"),re=c("panic"),le=c("test-burst"),A=c("search-box-serial"),U=c("auto-scroll-serial"),de=c("show-delta-serial"),v=c("pause-log-serial"),ue=c("clear-log-serial"),f=c("log-viewer-serial"),P=c("search-box-midi"),F=c("filter-midi-in"),V=c("filter-midi-out"),H=c("auto-scroll-midi"),he=c("show-delta-midi"),E=c("pause-log-midi"),ge=c("clear-log-midi"),fe=c("export-json"),me=c("export-csv"),m=c("log-viewer-midi"),x=c("knobs-grid"),ve=[1,2,4,5,6];function Ee(){L.innerHTML="";for(let s=0;s<7;s++){const e=s*2+(s>=3?-1:0),t=document.createElement("div");if(t.className="key",t.dataset.note=e.toString(),L.appendChild(t),ve.includes(s)){const n=document.createElement("div");n.className="key black",n.dataset.note=(e+1).toString(),L.appendChild(n)}}L.querySelectorAll(".key").forEach(s=>{const e=s;e.addEventListener("mousedown",()=>{const n=parseInt(e.dataset.note||"0")+l.getOctave()*12+24;l.sendNoteOn(n),e.classList.add("active")}),e.addEventListener("mouseup",()=>{const n=parseInt(e.dataset.note||"0")+l.getOctave()*12+24;l.isGateEnabled()||l.sendNoteOff(n),e.classList.remove("active")}),e.addEventListener("mouseleave",()=>{e.classList.remove("active")})})}const pe=[{name:"cutoff",label:"Cutoff",cc:74},{name:"resonance",label:"Resonance",cc:71},{name:"envMod",label:"Env Mod",cc:75},{name:"decay",label:"Decay",cc:76},{name:"accent",label:"Accent",cc:77},{name:"volume",label:"Volume",cc:7}];function be(){x.innerHTML="",pe.forEach(s=>{const e=document.createElement("div");e.className="knob-container";const t=document.createElement("div");t.className="knob",t.dataset.name=s.name;const n=document.createElement("div");n.className="knob-label",n.textContent=s.label;const i=document.createElement("div");i.className="knob-value",i.id=`knob-value-${s.name}`,i.textContent="64",e.appendChild(t),e.appendChild(n),e.appendChild(i),x.appendChild(e);let a=!1,o=0,u=64;t.addEventListener("mousedown",h=>{a=!0,o=h.clientY,u=l.getKnobValue(s.name),h.preventDefault()}),document.addEventListener("mousemove",h=>{if(!a)return;const Y=o-h.clientY,b=Math.max(0,Math.min(127,u+Math.floor(Y/2)));l.setKnobValue(s.name,b),i.textContent=b.toString();const j=b/127*270-135;t.style.transform=`rotate(${j}deg)`,l.sendCC(s.cc,b)}),document.addEventListener("mouseup",()=>{a=!1})})}R.addEventListener("click",async()=>{try{await l.connectBle(),w()}catch(s){alert(`BLE connection failed: ${s}`)}});_.addEventListener("click",async()=>{try{await l.connectSerial(),w()}catch(s){alert(`Serial connection failed: ${s}`)}});ce.addEventListener("click",()=>{l.setOctave(l.getOctave()-1),$.textContent=l.getOctave().toString()});oe.addEventListener("click",()=>{l.setOctave(l.getOctave()+1),$.textContent=l.getOctave().toString()});y.addEventListener("click",()=>{l.toggleGate(),y.classList.toggle("active")});D.addEventListener("click",()=>{l.toggleAccent(),D.classList.toggle("active")});N.addEventListener("click",()=>{l.toggleSlide(),N.classList.toggle("active")});re.addEventListener("click",()=>{l.allNotesOff()});le.addEventListener("click",()=>{l.sendTestBurst()});A.addEventListener("input",()=>{p()});U.addEventListener("change",()=>{});de.addEventListener("change",()=>{p()});v.addEventListener("click",()=>{d.isPaused()?(d.resume(),v.textContent="Pause",E.textContent="Pause"):(d.pause(),v.textContent="Resume",E.textContent="Resume")});ue.addEventListener("click",()=>{d.clear(),p(),g()});P.addEventListener("input",()=>{g()});F.addEventListener("change",()=>{g()});V.addEventListener("change",()=>{g()});H.addEventListener("change",()=>{});he.addEventListener("change",()=>{g()});E.addEventListener("click",()=>{d.isPaused()?(d.resume(),v.textContent="Pause",E.textContent="Pause"):(d.pause(),v.textContent="Resume",E.textContent="Resume")});ge.addEventListener("click",()=>{d.clear(),p(),g()});fe.addEventListener("click",()=>{K("cyd-debug-log.json",d.exportJson())});me.addEventListener("click",()=>{K("cyd-debug-log.csv",d.exportCsv())});function w(){const s=l.isBleConnected(),e=l.isSerialConnected();se.classList.toggle("connected",s),ie.textContent=s?"BLE: Connected":"BLE: Disconnected",ne.classList.toggle("connected",e),ae.textContent=e?"Serial: Connected":"Serial: Disconnected",R.textContent=s?"Disconnect BLE":"Connect BLE MIDI",_.textContent=e?"Disconnect Serial":"Connect Serial"}let C=!1,S=!1;function p(){C||(C=!0,requestAnimationFrame(()=>{const s=d.getEntries(),e=A.value.toLowerCase(),t=s.filter(a=>!(!(a.source==="SERIAL_IN"||a.source==="SERIAL_OUT")||e&&!a.text.toLowerCase().includes(e))),n=U.checked,i=f.scrollHeight-f.scrollTop<=f.clientHeight+50;f.innerHTML=t.map(a=>{const o=d.getSourceClass(a.source),u=d.formatEntry(a);return`<div class="log-entry ${o}">${u}</div>`}).join(""),n&&i&&(f.scrollTop=f.scrollHeight),C=!1}))}function g(){S||(S=!0,requestAnimationFrame(()=>{const s=d.getEntries(),e=P.value.toLowerCase(),t=s.filter(a=>!(a.source==="BLE_IN"&&!F.checked||(a.source==="BLE_OUT"||a.source==="UI_TO_MIDI")&&!V.checked||!(a.source==="BLE_IN"||a.source==="BLE_OUT"||a.source==="UI_TO_MIDI")||e&&!a.text.toLowerCase().includes(e))),n=H.checked,i=m.scrollHeight-m.scrollTop<=m.clientHeight+50;m.innerHTML=t.map(a=>{const o=d.getSourceClass(a.source),u=d.formatEntry(a);return`<div class="log-entry ${o}">${u}</div>`}).join(""),n&&i&&(m.scrollTop=m.scrollHeight),S=!1}))}k.subscribe(()=>{p(),g()});function K(s,e){const t=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download=s,i.click(),URL.revokeObjectURL(n)}Ee();be();w();console.log("aCYD-MIDI Web Debug Console initialized");
//# sourceMappingURL=index-BboSheKM.js.map
