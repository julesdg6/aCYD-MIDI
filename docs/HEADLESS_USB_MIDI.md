# Headless USB MIDI Build

## Overview

The headless build targets provide a compact, displayless MIDI controller solution using ESP32-S3 USB dongles. These builds are perfect for creating USB MIDI interfaces that can also act as ESP-NOW MIDI network masters.

## Features

### Supported MIDI Outputs
- ✅ **USB MIDI** - Native USB MIDI device (class-compliant, no drivers needed)
- ✅ **BLE MIDI** - Bluetooth Low Energy MIDI for wireless connectivity
- ✅ **Hardware MIDI** - Traditional DIN-5 MIDI output via UART
- ✅ **ESP-NOW MIDI** - Low-latency wireless MIDI network (master role)

### Key Capabilities
- **USB MIDI Device**: Plug-and-play USB MIDI interface for PC, Mac, Android, iOS, and Linux
- **ESP-NOW Master**: Acts as MIDI clock and message master for CYD network
- **Multi-output**: All MIDI messages simultaneously sent to USB, BLE, Hardware MIDI, and ESP-NOW
- **Low Latency**: Direct USB connection provides minimal latency compared to BLE
- **No Display**: Compact form factor with no touchscreen dependencies

## Hardware Requirements

### Recommended Boards
- **ESP32-S3 USB Dongle** - Small form factor USB stick with native USB support
  - Example: ESP32-S3-DevKitC-1
  - Example: ESP32-S3 "USB stick" dongles from AliExpress/Amazon
  - Must have USB-OTG (native USB) support

### Optional Hardware MIDI Output
If you want traditional DIN-5 MIDI output:
- MIDI DIN-5 connector
- 220Ω resistor
- Optocoupler (6N138 or equivalent)
- See [HARDWARE_MIDI.md](HARDWARE_MIDI.md) for full circuit details

## Build Targets

### `esp32s3-headless`
**Best for:** ESP32-S3 USB dongles with native USB support

**Features:**
- ✅ Native USB MIDI device (TinyUSB)
- ✅ BLE MIDI
- ✅ Hardware MIDI (UART2, GPIO16/17)
- ✅ ESP-NOW MIDI master

**Build command:**
```bash
pio run -e esp32s3-headless -t upload
```

### `esp32-headless-midi-master`
**Best for:** Standard ESP32 boards (no native USB support)

**Features:**
- ❌ No USB MIDI (requires ESP32-S3)
- ✅ BLE MIDI
- ✅ Hardware MIDI (UART2, GPIO16/17)
- ✅ ESP-NOW MIDI master

**Build command:**
```bash
pio run -e esp32-headless-midi-master -t upload
```

**Note:** Standard ESP32 does not have native USB support. USB MIDI requires ESP32-S3 or newer chips with built-in USB-OTG peripheral.

## Usage

### 1. Flash the Firmware

**Using PlatformIO:**
```bash
# For ESP32-S3 dongles
pio run -e esp32s3-headless -t upload

# For standard ESP32
pio run -e esp32-headless-midi-master -t upload
```

**Using Pre-built Binary:**
```bash
# Download from releases page
esptool.py --chip esp32s3 --port /dev/ttyUSB0 write_flash 0x10000 firmware-esp32s3-headless.bin
```

### 2. Connect to Computer

**USB MIDI (ESP32-S3 only):**
1. Plug the ESP32-S3 dongle into your computer's USB port
2. The device will enumerate as "aCYD-HEADLESS" USB MIDI device
3. Select "aCYD-HEADLESS" as MIDI input in your DAW
4. No drivers needed - works on Windows, Mac, Linux, Android, iOS

**BLE MIDI (all builds):**
1. Enable Bluetooth on your device
2. Pair with "aCYD-HEADLESS" 
3. Select as MIDI input in your DAW/app

### 3. ESP-NOW Network

The headless build acts as **ESP-NOW MIDI master**, broadcasting MIDI clock and messages to other CYD devices:

1. **On CYD devices**: Enable ESP-NOW in Settings
2. **Set Clock Master**: Set to "ESP-NOW MIDI" on receiving CYDs
3. **Automatic discovery**: CYDs will auto-discover the headless master

All MIDI messages generated by the headless master are broadcast to:
- USB MIDI (if connected)
- BLE MIDI (if paired)
- Hardware MIDI (if wired)
- ESP-NOW network (all discovered CYD peers)

## MIDI Functionality

### Generated MIDI Messages

The headless build continuously generates:
- **MIDI Clock** - 120 BPM (24 PPQN)
- **MIDI Start** - At startup
- **MIDI Stop** - Can be triggered via USB/BLE input

### Received MIDI Messages (ESP-NOW)

When receiving MIDI from ESP-NOW peers:
- Note On/Off
- Control Change
- MIDI Clock
- Start/Stop/Continue

These are **routed to all outputs**:
- USB MIDI
- BLE MIDI  
- Hardware MIDI

This creates a transparent MIDI network where all devices see all messages.

## Configuration

### MIDI Clock BPM

Default: 120 BPM

To change, edit `src/main_headless.cpp`:
```cpp
#define MIDI_BPM 120  // Change to desired BPM
```

### Hardware MIDI Pins

Default: UART2 (GPIO16=RX, GPIO17=TX)

To change, edit `src/main_headless.cpp`:
```cpp
#define MIDI_RX_PIN 16  // Change RX pin
#define MIDI_TX_PIN 17  // Change TX pin
```

### USB MIDI Device Name

Default: "aCYD-HEADLESS"

To change, edit `src/main_headless.cpp`:
```cpp
BLEDevice::init("aCYD-HEADLESS");  // Change BLE name
// USB name is inherited from board configuration
```

## Compatibility

### Operating Systems
- ✅ **Windows** - Works with any USB MIDI compatible DAW
- ✅ **macOS** - Works with Logic Pro, Ableton Live, GarageBand, etc.
- ✅ **Linux** - Works with JACK, ALSA MIDI
- ✅ **Android** - USB MIDI and BLE MIDI support
- ✅ **iOS/iPadOS** - USB MIDI (Camera Connection Kit) and BLE MIDI

### DAWs Tested
- Ableton Live
- FL Studio  
- Reaper
- GarageBand (iOS/macOS)
- Cubasis (iOS)

## Troubleshooting

### USB MIDI Not Detected

**ESP32-S3:**
- Verify you're using an ESP32-S3 board (native USB support)
- Check USB cable supports data (not charge-only)
- Try a different USB port
- Check Device Manager (Windows) or `lsusb` (Linux) for enumeration

**Standard ESP32:**
- USB MIDI is not supported on standard ESP32
- Use BLE MIDI or Hardware MIDI instead
- Or upgrade to ESP32-S3 board

### BLE MIDI Connection Issues
- Unpair and re-pair the device
- Restart Bluetooth on your device
- Check serial output for "BLE connected" message

### ESP-NOW Not Working
- Verify ESP-NOW is enabled in build (`-D ESP_NOW_ENABLED=1`)
- Check CYD devices are in ESP-NOW Broadcast or Peer mode
- Verify devices are within range (~100m)
- Check serial output for ESP-NOW initialization messages

### MIDI Messages Not Received
- Check MIDI routing in your DAW
- Verify MIDI channel (default: all channels)
- Check serial monitor for debug output
- Try different MIDI output (USB vs BLE vs Hardware)

## Advanced Configuration

### Disable Specific MIDI Outputs

Edit `platformio.ini` build flags:

```ini
# Disable USB MIDI (standard ESP32 only)
-D USB_MIDI_DEVICE=0

# Disable BLE MIDI
-D BLE_ENABLED=0

# Disable ESP-NOW
-D ESP_NOW_ENABLED=0
```

### Hardware MIDI on UART0

For production builds with hardware MIDI on serial breakout pins:

```cpp
#define HARDWARE_MIDI_UART 0
#define MIDI_RX_PIN 3
#define MIDI_TX_PIN 1
```

⚠️ **Note**: UART0 disables USB serial debugging.

## Performance

### Latency
- **USB MIDI**: <1ms (lowest latency)
- **BLE MIDI**: 10-20ms
- **ESP-NOW**: <10ms
- **Hardware MIDI**: ~1ms

### Throughput
- Can handle dense MIDI sequences
- Simultaneous multi-output with no dropouts
- Suitable for real-time performance

### Power Consumption
- USB-powered from computer
- ~50mA typical (BLE + WiFi active)
- ~30mA with BLE only (ESP-NOW disabled)

## Use Cases

### 1. USB MIDI Clock Master
- Connect ESP32-S3 dongle to computer via USB
- Provides USB MIDI clock at 120 BPM
- Sync multiple CYD devices via ESP-NOW
- Control DAW tempo from CYD touchscreen

### 2. Wireless MIDI Hub
- Bridge between USB MIDI and BLE MIDI
- Convert USB MIDI messages to wireless
- Route between different MIDI transports

### 3. ESP-NOW Network Master
- Central clock source for distributed CYD setup
- Broadcast MIDI clock to multiple devices
- Collect MIDI from CYDs and send to DAW via USB

### 4. Portable MIDI Interface
- Plug into iOS device (Camera Connection Kit)
- No batteries needed (USB-powered)
- Compact dongle form factor
- BLE backup if USB not available

## See Also

- [ESP-NOW MIDI Documentation](ESP_NOW_MIDI.md)
- [Hardware MIDI Setup](HARDWARE_MIDI.md)
- [Main README](../README.md)
- [Circuit Diagrams](CIRCUIT_DIAGRAMS.md)

## Credits

USB MIDI implementation uses:
- **Adafruit TinyUSB Library** - https://github.com/adafruit/Adafruit_TinyUSB_Arduino
- **FortySevenEffects MIDI Library** - https://github.com/FortySevenEffects/arduino_midi_library
- **ESP-NOW-MIDI Library** - https://github.com/grantler-instruments/ESP-NOW-MIDI
