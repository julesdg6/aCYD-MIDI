# Wi-Fi MIDI Implementation

## Overview

The Wi-Fi MIDI feature enables wireless MIDI communication over your local network. This allows the CYD to send and receive MIDI messages to/from DAWs, software synthesizers, and other MIDI-enabled devices without requiring Bluetooth or hardware MIDI connections.

## Architecture

### Protocol

The current implementation uses a **simple UDP-based protocol** for ease of integration and low latency:

- **Port**: 5004 (standard RTP-MIDI port)
- **Packet Format**: Same as BLE MIDI for consistency
  - Byte 0: `0x80` (header)
  - Byte 1: `0x80` (header)
  - Byte 2: MIDI status byte
  - Byte 3: MIDI data byte 1
  - Byte 4: MIDI data byte 2
- **Transport**: UDP (User Datagram Protocol)

### Design Decisions

**Why UDP instead of RTP-MIDI/AppleMIDI?**
- Simpler implementation with fewer dependencies
- Lower latency for musical use
- Easier to debug and troubleshoot
- Can be upgraded to full AppleMIDI in the future

**Future Enhancement**: Full RTP-MIDI/AppleMIDI support could be added using a dedicated library for better compatibility with macOS and iOS devices.

## Integration

### MIDI Pipeline

Wi-Fi MIDI is integrated into the existing MIDI pipeline alongside BLE and hardware MIDI:

```cpp
inline void sendMIDI(byte cmd, byte note, byte vel) {
  // Send via BLE MIDI
  if (deviceConnected) {
    // ... BLE transmission
  }
  
  // Send via Hardware MIDI (DIN-5 connector)
  sendHardwareMIDI(cmd, note, vel);
  
  // Send via Wi-Fi MIDI
  sendWiFiMIDI(cmd, note, vel);
}
```

All MIDI messages generated by any mode are automatically sent via all three outputs.

### Files

- **include/wifi_midi.h** - Header with public API
- **src/wifi_midi.cpp** - Implementation with WiFi-conditional compilation
- **src/main.cpp** - Initialization and main loop integration
- **include/midi_utils.h** - Updated to call sendWiFiMIDI()

## Configuration

### Build-Time Configuration

Wi-Fi MIDI requires `WIFI_ENABLED=1` in `platformio.ini`:

```ini
build_flags = 
    -D WIFI_ENABLED=1
```

When `WIFI_ENABLED=0`, all Wi-Fi MIDI functions become no-ops with zero overhead.

### Runtime Configuration

**Current Implementation:**
- Wi-Fi MIDI is disabled by default
- Target IP address is hardcoded: `192.168.1.100`
- Port is fixed: `5004`

**Planned Improvements:**
- UI toggle in Settings mode to enable/disable
- IP address configuration screen
- Auto-discovery via mDNS/Bonjour
- Support for multiple target devices

## Status Display

The Settings mode shows Wi-Fi MIDI status:

- **Disabled** - Feature not enabled
- **Enabled** - Feature enabled but not connected
- **Connected** - UDP socket active and ready

## Usage

### Current Usage (Manual)

1. Ensure Wi-Fi is connected (configure in `config/wifi_config.h`)
2. Call `setWiFiMIDIEnabled(true)` in code or add UI toggle
3. Configure target device to listen on UDP port 5004
4. Play notes on CYD - they will be sent to the target

### Future Usage (UI-Based)

1. Navigate to Settings mode
2. Select "Wi-Fi MIDI: Disabled" to toggle enable
3. Select "Configure Wi-Fi MIDI Target" to set IP address
4. Play normally - all MIDI goes to configured target

## Receiving MIDI

The current implementation can receive MIDI via Wi-Fi and logs it to serial console:

```
Wi-Fi MIDI RX: 90 3C 7F  // Note On C4, velocity 127
```

**Planned Feature**: Route received MIDI to:
- Internal synth engine (if added)
- Hardware MIDI output (CYD as a wireless bridge)
- Control parameters in different modes

## Performance

### Latency

UDP over Wi-Fi typically adds:
- **Local network**: 1-5ms
- **Same AP**: 2-10ms
- **Routed network**: 5-20ms

This is acceptable for most musical applications, though slightly higher than BLE MIDI or hardware MIDI.

### Bandwidth

MIDI over Wi-Fi uses minimal bandwidth:
- Each note: 5 bytes
- At 10 notes/second: 50 bytes/sec = 0.4 kbps
- Even dense playing (100 notes/sec) = 4 kbps

Wi-Fi can easily handle thousands of MIDI messages per second.

## Troubleshooting

### Wi-Fi MIDI Not Working

1. **Check Wi-Fi Connection**
   ```
   Settings > WiFi: Connected
   ```

2. **Verify Wi-Fi MIDI is Enabled**
   ```cpp
   setWiFiMIDIEnabled(true);  // In code
   ```

3. **Check Target IP Address**
   - Default is `192.168.1.100`
   - Must match your receiving device

4. **Firewall Issues**
   - Some systems block UDP port 5004
   - Add firewall exception for port 5004

5. **Network Issues**
   - CYD and target must be on same network
   - Some guest networks block device-to-device communication

### Testing Wi-Fi MIDI

**Receive Test on macOS/Linux:**
```bash
nc -u -l 5004 | hexdump -C
```

**Receive Test on Windows:**
```powershell
# Use UDP test tool or MIDI monitoring software
```

## Companion Software

To receive Wi-Fi MIDI in a DAW, you need software that creates a virtual MIDI port from UDP:

### Option 1: rtpmidid (Linux)
```bash
sudo rtpmidid
```

### Option 2: MIDI Monitor (macOS)
- Download from snoize.com
- Listen for network MIDI

### Option 3: Custom Bridge
Create a simple UDP-to-MIDI bridge in Python:

```python
import socket
import mido

sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
sock.bind(('0.0.0.0', 5004))

port = mido.open_output('Virtual MIDI')

while True:
    data, addr = sock.recvfrom(5)
    if len(data) == 5 and data[0] == 0x80 and data[1] == 0x80:
        status, data1, data2 = data[2], data[3], data[4]
        msg = mido.Message.from_bytes([status, data1, data2])
        port.send(msg)
```

## Security Considerations

**Current Implementation:**
- No encryption
- No authentication
- Broadcasts to configured IP only

**Acceptable for:**
- Home studio networks
- Trusted local networks
- Non-internet-connected devices

**Not recommended for:**
- Public Wi-Fi
- Internet-exposed networks
- Scenarios requiring privacy

## Future Enhancements

1. **Full RTP-MIDI Support**
   - Session negotiation
   - Journal/recovery for packet loss
   - Apple/iOS compatibility

2. **Configuration UI**
   - IP address input screen
   - Multiple target devices
   - mDNS device discovery

3. **Bidirectional MIDI**
   - Route received MIDI to modes
   - Use CYD as wireless MIDI bridge
   - Software control of CYD parameters

4. **Advanced Features**
   - MIDI clock sync over Wi-Fi
   - Multi-client support
   - Latency compensation

## References

- [RFC 6295: RTP Payload Format for MIDI](https://www.rfc-editor.org/rfc/rfc6295)
- [Apple MIDI Network Protocol](https://developer.apple.com/documentation/coremidi)
- [MIDI Over WiFi (MIDI.org)](https://www.midi.org/specifications)
